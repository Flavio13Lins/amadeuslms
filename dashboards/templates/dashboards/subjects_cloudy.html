<!-- 
Copyright 2016, 2017 UFPE - Universidade Federal de Pernambuco
 
Este arquivo é parte do programa Amadeus Sistema de Gestão de Aprendizagem, ou simplesmente Amadeus LMS
 
O Amadeus LMS é um software livre; você pode redistribui-lo e/ou modifica-lo dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação do Software Livre (FSF); na versão 2 da Licença.
 
Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU para maiores detalhes.
 
Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título "LICENSE", junto com este programa, se não, escreva para a Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA.
-->

{% load static i18n %}

{#{{ tags_cloud }}#}

<script src="{% static 'analytics/js/ToolTip.js' %}"></script>
<script src="{% static 'analytics/js/d3.v3.min.js' %}"></script>
<script src="{% static 'analytics/js/cloud.min.js' %}"></script>

<div id="cloudy" class="col-md-8 col-xs-12 col-sm-12 col-lg-8">
    <div style="font-size:16px; text-align:left; color: #000; padding-left: 10px; ">
        <b>{% trans 'Most searched terms' %}</b>
    </div>
    <hr style="height:2px; background-color:#878787;margin-top: 5px;margin-bottom: 5px;">
</div>

<div class="modal fade" id="tagModal" tabindex="-1" role="dialog" aria-labelledby="modalTittle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div style="float: left;">
                    <h3 class="modal-title" id="modalTittle">Modal title</h3>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding-top:5px" class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
                <!--<div style="margin-top: 15px">
                    <h4>{% trans 'Access frequency' %}:</h4>
                    <p>{% trans 'My frequency' %}: <a id="my-access-modal">0</a></br>
                        {% trans 'Frequency of the class' %}: <a id="total-access-modal">0</a></p>
                </div>
                <hr style="height:2px; background-color:#878787;margin-top: 5px;margin-bottom: 5px;">
                    <div class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
                        <div class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
                            <div class="col-md-6 col-xs-6 col-sm-6 col-lg-6" ><h5>{% trans 'Resource' %}</h5></div>
                            <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3" ><h5>{% trans 'My frequency' %}</h5></div>
                            <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3" ><h5>{% trans 'Frequency of the class' %}</h5></div>
                        </div>
                    </div>
                    <hr style="height:2px; background-color:#959595;margin-top: 0px;margin-bottom: 5px;">
                    <div id="resources-list" style="overflow-y: auto; height:200px; " class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
            
                    </div>
                    -->
                <div>
                    <div class="table-responsive-sm">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th colspan="2" scope="col">Acessos(%)</th>
                                </tr>
                                <tr>
                                    <th scope="col">Seu</th>
                                    <th scope="col">Turma</th>
                                    <th scope="col">Recurso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>28%</td>
                                    <td>28%</td>
                                    <td>Aulas Expositivas/ Exercicios(3ª Etapa)</td>
                                </tr>
                                <tr>
                                    <td>28%</td>
                                    <td>28%</td>
                                    <td>Aula 12</td>
                                </tr>
                                <tr>
                                    <td>14%</td>
                                    <td>14%</td>
                                    <td>Aulas Expositivas/ Exercicios(1ª Etapa)</td>
                                </tr>

                            </tbody>
                        </table>
                    </div>
                </div>
                <nav aria-label="Table Navigation">
                    <ul class="pagination">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                        <li class="page-item page-item-number"><a class="page-link" href="#">1</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <!--<div class="modal-footer" class="col-md-12 col-xs-12 col-sm-12 col-lg-12">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'CLOSE' %}</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>-->
    </div>
</div>

<script type="text/javascript">
    /*Cloudy Word*/

    temp = document.getDimensions("#cloudy")
    var width = temp.w - $("#cloudy").css("padding-left").match(/[0-9]+/)[0] - $("#cloudy").css("padding-right").match(/[0-9]+/)[0];;
    var height = width * 1 / 2 > 360 ? 360 : (width / 2 < 50 ? 50 : width / 2);

    var qtd_students = {{ qtd_students }};

    var data = {% autoescape off %} {{ tags_cloud }} {% endautoescape %};

    data = data.map(function (d) {
        return {
            key: d.tag_name,
            value: d.qtd_access,
            myvalue: d.qtd_my_access,
            link: d.details_url
        }
    });

    data.sort(function (d1, d2) {
        return d1.value > d2.value ? -1 : (d1.value < d2.value ? 1 : 0);
    })

    data = data.slice(0, 30);

    var dataconfig = {
        parent: "#cloudy",
        data: data,
        max: 50,
        font: "Impact",
        spiral: "rectangular",// archimedean | rectangular
        scale: "log",// scaleLinear | scaleSqrt | scaleLog
        angles: {
            from: 0,
            to: 0,
            n: 1
        },
        dimensions: {
            w: width,
            h: height,
        },
        interactions: {
            click: function (element, data) {
                //console.log(data);
                //alert(d3.textData(data, "<text>: <value> acesso(s) \nMeus acessos: <myvalue>"))
                var modal = document.querySelector('#tagModal');
                modal.querySelector("#modalTittle").innerText = data.text.toUpperCase();
                //modal.querySelector("#my-access-modal").innerText = "" + parseInt(data.myvalue * 100 / cloudWord.chartConfig.mymax) + "%";
                //modal.querySelector("#total-access-modal").innerText = "" + parseInt(data.value * 100 / cloudWord.chartConfig.max) + "%";

                //modal.querySelector("#my-access-modal2").innerText = data.myvalue;
                //modal.querySelector("#total-access-modal2").innerText = data.value/qtd_students;
                var container = d3.select("#resources-list");
                container.selectAll(".resource").remove();

                $.get(data.link, function (dataset) {
                    dataset = dataset.sort(function (d1, d2) {
                        if (isNaN(d1.qtd_access) || (+d1.qtd_access) == 0)
                            d1.qtd_access = 0;
                        if (isNaN(d2.qtd_access) || (+d2.qtd_access) == 0)
                            d2.qtd_access = 0;

                        if (isNaN(d1.qtd_my_access) || (+d1.qtd_my_access) == 0)
                            d1.qtd_access = 0;
                        if (isNaN(d2.qtd_my_access) || (+d2.qtd_my_access) == 0)
                            d2.qtd_access = 0;

                        var p1 = d1.qtd_my_access / d1.qtd_access, p2 = d2.qtd_my_access / d2.qtd_access;
                        return p1 > p2 ? 1 : (p1 < p2 ? -1 : (d1.qtd_access < d2.qtd_access ? 1 : (d1.qtd_access > d2.qtd_access ? -1 : 0)));
                    });

                    var resources = container.selectAll(".resource").data(dataset).enter().append("div")
                        .attr("class", function (d, i) { return "resource recource-" + i + " col-md-12 col-xs-12 col-sm-12 col-lg-12" });
                    //.style("padding-left",0);

                    /*resources.append("div").attr("class", "resource-name col-md-6 col-xs-6 col-sm-6 col-lg-6")
                        .append("p")
                        .append("a").attr("href", function (d) { return d.access_url })
                        .text(function (d) {
                            return d.resource_name
                        });

                    resources.append("div").attr("class", "myfreq col-md-3 col-xs-3 col-sm-3 col-lg-3")
                        .append("p").text(function (d) {
                            console.log("qtd_my_access: " + d.qtd_my_access, "my_access_tag: " + data.myvalue);
                            return "" + parseInt(d.qtd_my_access * 100 / (data.myvalue || 1)) + "%";
                        });

                    resources.append("div").attr("class", "totalfreq col-md-3 col-xs-3 col-sm-3 col-lg-3")
                        .append("p").text(function (d) {
                            console.log("qtd_access: " + d.qtd_access, "access_tag: " + data.value);
                            return "" + parseInt(d.qtd_access * 100 / (data.value || 1)) + "%";
                        });*/

                });

                $('#tagModal').modal('show');
            }
        },
        tooltip: {
            text: "Tag: <key>\nTotal de acessos: <value> \nMeus acessos: <myvalue>",
        },
        filltext: function (a) {
            var fill = d3.interpolateGreens;
            var prop = a.chartConfig.mymax / a.chartConfig.max;
            function scalePercent(x, y) {
                if (x > y)
                    return y * 0.3 * prop / x;
                else
                    return 1 - x * .7 / (y * prop);
            }
            //console.log(prop);
            a.words.attr("fill", function (d, i) {
                //console.log(scalePercent(d.myvalue,d.value));
                return fill(scalePercent(d.myvalue, d.value));
            });
        },
        /*default:function(){
            var temp = document.querySelector("#bullet-tag").getBoundingClientRect();
            this.bullet_tag = d3.scaleLinear().range[0,(temp.width-75)<0?0:temp.width-75];

        }*/
    }
    var cloudWord = new CloudWord(dataconfig);
</script>